{% extends "base_admin.html" %}
{% load humanize %}
{% block content %}
<h2>ğŸ“Š BÃ¡o cÃ¡o tá»•ng há»£p</h2>

<!-- ThÃªm Chart.js & Datalabels Plugin -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<div class="container">
    <h1>Thá»‘ng kÃª quáº£n trá»‹</h1>

    <h2>Doanh thu</h2>
    <ul>
        <li>HÃ´m nay: {{ revenue_today|intcomma }} VND</li>
        <li>ThÃ¡ng nÃ y: {{ revenue_month|intcomma }} VND</li>
        <li>NÄƒm nay: {{ revenue_year|intcomma }} VND</li>
    </ul>

    <canvas id="revenueChart" height="100"></canvas>

    <h2>Sá»‘ Ä‘Æ¡n hÃ ng</h2>
    <ul>
        <li>HÃ´m nay: {{ orders_today }}</li>
        <li>ThÃ¡ng nÃ y: {{ orders_month }}</li>
        <li>NÄƒm nay: {{ orders_year }}</li>
    </ul>

    <canvas id="ordersChart" height="100"></canvas>

    <h2>Top 5 sáº£n pháº©m bÃ¡n cháº¡y</h2>
    <ul>
        {% for item in top_products %}
        <li>{{ item.product__name }}: {{ item.total_sold }} cÃ¡i</li>
        {% endfor %}
    </ul>

    <canvas id="productChart" height="100"></canvas>

    <h2>NgÆ°á»i dÃ¹ng má»›i trong thÃ¡ng: {{ new_users }}</h2>

    <h2>ğŸ“ˆ Doanh thu theo thÃ¡ng</h2>
    <canvas id="monthlyRevenueChart" height="120"></canvas>
</div>

<script>
    Chart.register(ChartDataLabels);

    // Doanh thu theo ngÃ y/thÃ¡ng/nÄƒm
    new Chart(document.getElementById('revenueChart'), {
        type: 'bar',
        data: {
            labels: ['HÃ´m nay', 'ThÃ¡ng nÃ y', 'NÄƒm nay'],
            datasets: [{
                label: 'Doanh thu (VND)',
                data: [{{ revenue_today }}, {{ revenue_month }}, {{ revenue_year }}],
                backgroundColor: '#4caf50'
            }]
        },
        options: {
            plugins: {
                datalabels: {
                    anchor: 'end',
                    align: 'top',
                    formatter: v => v.toLocaleString('vi-VN'),
                    font: { weight: 'bold' }
                }
            },
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: value => value.toLocaleString('vi-VN')
                    }
                }
            }
        },
        plugins: [ChartDataLabels]
    });

    // Sá»‘ Ä‘Æ¡n hÃ ng theo ngÃ y/thÃ¡ng/nÄƒm
    new Chart(document.getElementById('ordersChart'), {
        type: 'bar',
        data: {
            labels: ['HÃ´m nay', 'ThÃ¡ng nÃ y', 'NÄƒm nay'],
            datasets: [{
                label: 'Sá»‘ Ä‘Æ¡n hÃ ng',
                data: [{{ orders_today }}, {{ orders_month }}, {{ orders_year }}],
                backgroundColor: '#2196f3'
            }]
        },
        options: {
            plugins: {
                datalabels: {
                    anchor: 'end',
                    align: 'top',
                    formatter: v => v,
                    font: { weight: 'bold' }
                }
            },
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        },
        plugins: [ChartDataLabels]
    });

    // Top sáº£n pháº©m bÃ¡n cháº¡y
    new Chart(document.getElementById('productChart'), {
        type: 'bar',
        data: {
            labels: [{% for item in top_products %}'{{ item.product__name }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
            datasets: [{
                label: 'Sá»‘ lÆ°á»£ng bÃ¡n',
                data: [{% for item in top_products %}{{ item.total_sold }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                backgroundColor: '#ff9800'
            }]
        },
        options: {
            plugins: {
                datalabels: {
                    anchor: 'end',
                    align: 'top',
                    formatter: v => v,
                    font: { weight: 'bold' }
                }
            },
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        },
        plugins: [ChartDataLabels]
    });

    // Biá»ƒu Ä‘á»“ doanh thu theo thÃ¡ng
    new Chart(document.getElementById('monthlyRevenueChart'), {
        type: 'bar',
        data: {
            labels: {{ chart_labels|safe }},
            datasets: [{
                label: 'Doanh thu theo thÃ¡ng (VND)',
                data: {{ chart_data|safe }},
                backgroundColor: '#673ab7'
            }]
        },
        options: {
            plugins: {
                datalabels: {
                    anchor: 'end',
                    align: 'top',
                    formatter: v => v.toLocaleString('vi-VN'),
                    font: { weight: 'bold' }
                },
                tooltip: {
                    callbacks: {
                        label: context => context.dataset.label + ': ' + context.raw.toLocaleString('vi-VN') + ' VND'
                    }
                }
            },
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: value => value.toLocaleString('vi-VN')
                    }
                }
            }
        },
        plugins: [ChartDataLabels]
    });
</script>
{% endblock %}
