{% extends "base_admin.html" %}
{% load humanize %}
{% block content %}
<h2>📊 Báo cáo tổng hợp</h2>

<!-- Thêm Chart.js & Datalabels Plugin -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<div class="container">
    <h1>Thống kê quản trị</h1>

    <h2>Doanh thu</h2>
    <ul>
        <li>Hôm nay: {{ revenue_today|intcomma }} VND</li>
        <li>Tháng này: {{ revenue_month|intcomma }} VND</li>
        <li>Năm nay: {{ revenue_year|intcomma }} VND</li>
    </ul>

    <canvas id="revenueChart" height="100"></canvas>

    <h2>Số đơn hàng</h2>
    <ul>
        <li>Hôm nay: {{ orders_today }}</li>
        <li>Tháng này: {{ orders_month }}</li>
        <li>Năm nay: {{ orders_year }}</li>
    </ul>

    <canvas id="ordersChart" height="100"></canvas>

    <h2>Top 5 sản phẩm bán chạy</h2>
    <ul>
        {% for item in top_products %}
        <li>{{ item.product__name }}: {{ item.total_sold }} cái</li>
        {% endfor %}
    </ul>

    <canvas id="productChart" height="100"></canvas>

    <h2>Người dùng mới trong tháng: {{ new_users }}</h2>

    <h2>📈 Doanh thu theo tháng</h2>
    <canvas id="monthlyRevenueChart" height="120"></canvas>
</div>

<script>
    Chart.register(ChartDataLabels);

    // Doanh thu theo ngày/tháng/năm
    new Chart(document.getElementById('revenueChart'), {
        type: 'bar',
        data: {
            labels: ['Hôm nay', 'Tháng này', 'Năm nay'],
            datasets: [{
                label: 'Doanh thu (VND)',
                data: [{{ revenue_today }}, {{ revenue_month }}, {{ revenue_year }}],
                backgroundColor: '#4caf50'
            }]
        },
        options: {
            plugins: {
                datalabels: {
                    anchor: 'end',
                    align: 'top',
                    formatter: v => v.toLocaleString('vi-VN'),
                    font: { weight: 'bold' }
                }
            },
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: value => value.toLocaleString('vi-VN')
                    }
                }
            }
        },
        plugins: [ChartDataLabels]
    });

    // Số đơn hàng theo ngày/tháng/năm
    new Chart(document.getElementById('ordersChart'), {
        type: 'bar',
        data: {
            labels: ['Hôm nay', 'Tháng này', 'Năm nay'],
            datasets: [{
                label: 'Số đơn hàng',
                data: [{{ orders_today }}, {{ orders_month }}, {{ orders_year }}],
                backgroundColor: '#2196f3'
            }]
        },
        options: {
            plugins: {
                datalabels: {
                    anchor: 'end',
                    align: 'top',
                    formatter: v => v,
                    font: { weight: 'bold' }
                }
            },
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        },
        plugins: [ChartDataLabels]
    });

    // Top sản phẩm bán chạy
    new Chart(document.getElementById('productChart'), {
        type: 'bar',
        data: {
            labels: [{% for item in top_products %}'{{ item.product__name }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
            datasets: [{
                label: 'Số lượng bán',
                data: [{% for item in top_products %}{{ item.total_sold }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                backgroundColor: '#ff9800'
            }]
        },
        options: {
            plugins: {
                datalabels: {
                    anchor: 'end',
                    align: 'top',
                    formatter: v => v,
                    font: { weight: 'bold' }
                }
            },
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        },
        plugins: [ChartDataLabels]
    });

    // Biểu đồ doanh thu theo tháng
    new Chart(document.getElementById('monthlyRevenueChart'), {
        type: 'bar',
        data: {
            labels: {{ chart_labels|safe }},
            datasets: [{
                label: 'Doanh thu theo tháng (VND)',
                data: {{ chart_data|safe }},
                backgroundColor: '#673ab7'
            }]
        },
        options: {
            plugins: {
                datalabels: {
                    anchor: 'end',
                    align: 'top',
                    formatter: v => v.toLocaleString('vi-VN'),
                    font: { weight: 'bold' }
                },
                tooltip: {
                    callbacks: {
                        label: context => context.dataset.label + ': ' + context.raw.toLocaleString('vi-VN') + ' VND'
                    }
                }
            },
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: value => value.toLocaleString('vi-VN')
                    }
                }
            }
        },
        plugins: [ChartDataLabels]
    });
</script>
{% endblock %}
