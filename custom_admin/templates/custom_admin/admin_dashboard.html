{% extends "base_admin.html" %}
{% load humanize %}
{% block content %}
<div class="container mt-4">
    <h2 class="text-center mb-4" style="color: #007bff;">üìä B√°o c√°o t·ªïng h·ª£p</h2>

    <!-- Form t√¨m ki·∫øm -->
    <form method="POST" class="mb-4">
        {% csrf_token %}
        <div class="row g-3">
            <div class="col-md-3">
                <label for="start_date" class="form-label">T·ª´ ng√†y</label>
                <input type="date" class="form-control" id="start_date" name="start_date" value="{{ start_date }}">
            </div>
            <div class="col-md-3">
                <label for="end_date" class="form-label">ƒê·∫øn ng√†y</label>
                <input type="date" class="form-control" id="end_date" name="end_date" value="{{ end_date }}">
            </div>
            <!-- <div class="col-md-4">
                <label for="product_query" class="form-label">T√¨m s·∫£n ph·∫©m</label>
                <input type="text" class="form-control" id="product_query" name="product_query" value="{{ product_query }}" placeholder="Nh·∫≠p t√™n s·∫£n ph·∫©m">
            </div> -->
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary me-2">T√¨m ki·∫øm</button>
                <a href="{% url 'custom_admin:dashboard' %}" class="btn btn-secondary">X√≥a b·ªô l·ªçc</a>
            </div>
        </div>
    </form>

    <!-- Th·ªëng k√™ -->
    <div class="row">
        <!-- Doanh thu -->
        <div class="col-md-4">
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5>Doanh thu</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li><strong>H√¥m nay:</strong> {{ revenue_today|intcomma }} VND</li>
                        <li><strong>Th√°ng n√†y:</strong> {{ revenue_month|intcomma }} VND</li>
                        <li><strong>NƒÉm nay:</strong> {{ revenue_year|intcomma }} VND</li>
                    </ul>
                    <canvas id="revenueChart" height="100"></canvas>
                </div>
            </div>
        </div>

        <!-- S·ªë ƒë∆°n h√†ng -->
        <div class="col-md-4">
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5>S·ªë ƒë∆°n h√†ng</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li><strong>H√¥m nay:</strong> {{ orders_today }}</li>
                        <li><strong>Th√°ng n√†y:</strong> {{ orders_month }}</li>
                        <li><strong>NƒÉm nay:</strong> {{ orders_year }}</li>
                    </ul>
                    <canvas id="ordersChart" height="100"></canvas>
                </div>
            </div>
        </div>

        <!-- Top s·∫£n ph·∫©m b√°n ch·∫°y -->
        <div class="col-md-4">
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-warning text-dark">
                    <h5>Top 5 s·∫£n ph·∫©m b√°n ch·∫°y</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        {% for item in top_products %}
                        <li>{{ item.product__name }}: {{ item.total_sold }} c√°i</li>
                        {% empty %}
                        <li>Kh√¥ng c√≥ d·ªØ li·ªáu</li>
                        {% endfor %}
                    </ul>
                    <canvas id="productChart" height="100"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Doanh thu theo th√°ng -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-purple text-white" style="background-color: #673ab7;">
            <h5>üìà Doanh thu theo th√°ng</h5>
        </div>
        <div class="card-body">
            <canvas id="monthlyRevenueChart" height="120"></canvas>
        </div>
    </div>
</div>

<!-- Th√™m Chart.js & Datalabels Plugin -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<script>
    Chart.register(ChartDataLabels);

    // Doanh thu
    new Chart(document.getElementById('revenueChart'), {
        type: 'bar',
        data: {
            labels: ['H√¥m nay', 'Th√°ng n√†y', 'NƒÉm nay'],
            datasets: [{
                label: 'Doanh thu (VND)',
                data: [{{ revenue_today }}, {{ revenue_month }}, {{ revenue_year }}],
                backgroundColor: ['#28a745', '#20c997', '#17a2b8'],
                borderColor: ['#1e7e34', '#1aab87', '#117a8b'],
                borderWidth: 1
            }]
        },
        options: {
            plugins: {
                datalabels: {
                    anchor: 'end',
                    align: 'top',
                    formatter: v => v.toLocaleString('vi-VN') + ' VND',
                    font: { weight: 'bold', size: 12 },
                    color: '#000'
                },
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: ctx => `${ctx.dataset.label}: ${ctx.raw.toLocaleString('vi-VN')} VND`
                    }
                }
            },
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: '#e9ecef' },
                    ticks: {
                        callback: value => value.toLocaleString('vi-VN'),
                        stepSize: Math.max({{ revenue_year|default:1 }} / 5, 100000)
                    }
                },
                x: { grid: { display: false } }
            }
        }
    });

    // S·ªë ƒë∆°n h√†ng
    new Chart(document.getElementById('ordersChart'), {
        type: 'bar',
        data: {
            labels: ['H√¥m nay', 'Th√°ng n√†y', 'NƒÉm nay'],
            datasets: [{
                label: 'S·ªë ƒë∆°n h√†ng',
                data: [{{ orders_today }}, {{ orders_month }}, {{ orders_year }}],
                backgroundColor: ['#007bff', '#6610f2', '#6f42c1'],
                borderColor: ['#005cbf', '#520dc2', '#5a32a3'],
                borderWidth: 1
            }]
        },
        options: {
            plugins: {
                datalabels: {
                    anchor: 'end',
                    align: 'top',
                    formatter: v => v,
                    font: { weight: 'bold', size: 12 },
                    color: '#000'
                },
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: ctx => `${ctx.dataset.label}: ${ctx.raw}`
                    }
                }
            },
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: '#e9ecef' },
                    ticks: { stepSize: 1 }
                },
                x: { grid: { display: false } }
            }
        }
    });

    // Top s·∫£n ph·∫©m b√°n ch·∫°y (c·ªôt ngang)
    new Chart(document.getElementById('productChart'), {
        type: 'bar',
        data: {
            labels: [{% for item in top_products %}'{{ item.product__name|truncatechars:30 }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
            datasets: [{
                label: 'S·ªë l∆∞·ª£ng b√°n',
                data: [{% for item in top_products %}{{ item.total_sold }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                backgroundColor: ['#ffc107', '#fd7e14', '#f1c40f', '#e67e22', '#d4a017'],
                borderColor: ['#d39e00', '#c76300', '#dab10d', '#b5651d', '#b58900'],
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y', // Chuy·ªÉn sang c·ªôt ngang
            plugins: {
                datalabels: {
                    anchor: 'end',
                    align: 'right',
                    formatter: v => v,
                    font: { weight: 'bold', size: 12 },
                    color: '#000'
                },
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: ctx => `${ctx.dataset.label}: ${ctx.raw}`
                    }
                }
            },
            responsive: true,
            scales: {
                x: {
                    beginAtZero: true,
                    grid: { color: '#e9ecef' },
                    ticks: { stepSize: 1 }
                },
                y: { grid: { display: false } }
            }
        }
    });

    // Doanh thu theo th√°ng (bi·ªÉu ƒë·ªì ƒë∆∞·ªùng)
    new Chart(document.getElementById('monthlyRevenueChart'), {
        type: 'line',
        data: {
            labels: {{ chart_labels|safe }},
            datasets: [{
                label: 'Doanh thu theo th√°ng (VND)',
                data: {{ chart_data|safe }},
                fill: false,
                borderColor: '#673ab7',
                backgroundColor: '#673ab7',
                tension: 0.1
            }]
        },
        options: {
            plugins: {
                datalabels: {
                    anchor: 'end',
                    align: 'top',
                    formatter: v => v.toLocaleString('vi-VN') + ' VND',
                    font: { weight: 'bold', size: 12 },
                    color: '#000'
                },
                tooltip: {
                    callbacks: {
                        label: ctx => `${ctx.dataset.label}: ${ctx.raw.toLocaleString('vi-VN')} VND`
                    }
                }
            },
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: '#e9ecef' },
                    ticks: {
                        callback: value => value.toLocaleString('vi-VN'),
                        stepSize: Math.max(Math.max(...{{ chart_data|safe }}||[1]) / 5, 100000)
                    }
                },
                x: { grid: { display: false } }
            }
        }
    });
</script>
{% endblock %}