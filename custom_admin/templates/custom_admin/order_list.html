{% extends "base_admin.html" %}
{% load humanize %}
{% block content %}
<h3>Danh sÃ¡ch Ä‘Æ¡n hÃ ng</h3>

<form method="get" class="mb-3">
  <div class="row align-items-center">
    <div class="col-md-4">
      <input type="text" name="search" value="{{ search_query }}" placeholder="TÃ¬m kiáº¿m theo sá»‘ Ä‘iá»‡n thoáº¡i"
        class="form-control" />
    </div>
    <div class="col-md-3">
      <select name="status" class="form-select">
        <option value="" {% if not status_filter %}selected{% endif %}>Táº¥t cáº£ tráº¡ng thÃ¡i</option>
        <option value="0" {% if status_filter == '0' %}selected{% endif %}>ğŸ•’ Äang chá» xÃ¡c nháº­n</option>
        <option value="1" {% if status_filter == '1' %}selected{% endif %}>âœ… ÄÃ£ xÃ¡c nháº­n</option>
        <option value="2" {% if status_filter == '2' %}selected{% endif %}>ğŸšš Äang giao hÃ ng</option>
        <option value="3" {% if status_filter == '3' %}selected{% endif %}>ğŸ“¦ Giao hÃ ng thÃ nh cÃ´ng</option>
      </select>
    </div>
    <div class="col-md-5 d-flex">
      <button type="submit" class="btn btn-primary me-2">TÃ¬m kiáº¿m</button>
      <a href="{% url 'custom_admin:order_list' %}" class="btn btn-secondary">Äáº·t láº¡i</a>
    </div>
  </div>
</form>

<div style="max-height: 500px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 5px;">
  <table class="table table-bordered table-hover mb-0">
    <thead class="table-light">
      <tr>
        <th>STT</th>
        <th>KhÃ¡ch hÃ ng</th>
        <th>NgÃ y táº¡o</th>
        <th>Tá»•ng tiá»n</th>
        <th>Sá»‘ Ä‘iá»‡n thoáº¡i</th>
        <th>Äá»‹a chá»‰</th>
        <th>Tráº¡ng thÃ¡i</th>
        <th>HÃ nh Ä‘á»™ng</th>
      </tr>
    </thead>
    <tbody>
      {% for order in orders %}
      <tr>
        <td>{{ forloop.counter }}</td>
        <td>{{ order.user.username }}</td>
        <td>{{ order.create_date|date:"d \T\hÃ¡\n\g m, Y" }}</td>
        <td>{{ order.total_amount|intcomma }} VND</td>
        <td>{{ order.phone }}</td>
        <td>{{ order.address }}</td>
        <td>
          <select class="form-select status-select" data-order-id="{{ order.id }}">
            <option value="{{ order.status }}" selected>
              {% if order.status == 0 %}ğŸ•’ Äang chá» xÃ¡c nháº­n
              {% elif order.status == 1 %}âœ… ÄÃ£ xÃ¡c nháº­n
              {% elif order.status == 2 %}ğŸšš Äang giao hÃ ng
              {% elif order.status == 3 %}ğŸ“¦ Giao hÃ ng thÃ nh cÃ´ng
              {% else %}â“ KhÃ´ng xÃ¡c Ä‘á»‹nh
              {% endif %}
            </option>
            {% if order.status < 3 %} <option value="{{ order.status|add:1 }}">
              {% if order.status == 0 %}âœ… ÄÃ£ xÃ¡c nháº­n
              {% elif order.status == 1 %}ğŸšš Äang giao hÃ ng
              {% elif order.status == 2 %}ğŸ“¦ Giao hÃ ng thÃ nh cÃ´ng
              {% endif %}
              </option>
              {% endif %}
          </select>
        </td>
        <td>
          <a href="{% url 'custom_admin:order_detail' order.id %}" class="btn btn-sm btn-info">Xem</a>
          <a href="{% url 'custom_admin:order_edit' order.id %}" class="btn btn-sm btn-warning">Sá»­a</a>
          <form action="{% url 'custom_admin:order_delete' order.id %}" method="post" style="display:inline;">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-danger"
              onclick="return confirm('Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a Ä‘Æ¡n hÃ ng nÃ y?')">XÃ³a</button>
          </form>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="8">KhÃ´ng cÃ³ Ä‘Æ¡n hÃ ng nÃ o.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  $(document).ready(function () {
    $('.status-select').change(function () {
      var orderId = $(this).data('order-id');
      var newStatus = $(this).val();

      $.ajax({
        url: '{% url "custom_admin:order_update_status" %}',
        type: 'POST',
        data: {
          order_id: orderId,
          status: newStatus,
          csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        success: function (response) {
          if (response.success) {
            alert('Cáº­p nháº­t tráº¡ng thÃ¡i thÃ nh cÃ´ng!');
          } else {
            alert('CÃ³ lá»—i xáº£y ra: ' + response.error);
            location.reload();
          }
        },
        error: function () {
          alert('Lá»—i káº¿t ná»‘i, vui lÃ²ng thá»­ láº¡i.');
          location.reload();
        }
      });
    });
  });
</script>
{% endblock %}