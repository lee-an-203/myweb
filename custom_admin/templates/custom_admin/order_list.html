{% extends "base_admin.html" %}
{% load humanize %}
{% block content %}
<h3>Danh sách đơn hàng</h3>

<form method="get" class="mb-3">
  <div class="row align-items-center">
    <div class="col-md-4">
      <input type="text" name="search" value="{{ search_query }}" placeholder="Tìm kiếm theo số điện thoại"
        class="form-control" />
    </div>
    <div class="col-md-3">
      <select name="status" class="form-select">
        <option value="" {% if not status_filter %}selected{% endif %}>Tất cả trạng thái</option>
        <option value="0" {% if status_filter == '0' %}selected{% endif %}>🕒 Đang chờ xác nhận</option>
        <option value="1" {% if status_filter == '1' %}selected{% endif %}>✅ Đã xác nhận</option>
        <option value="2" {% if status_filter == '2' %}selected{% endif %}>🚚 Đang giao hàng</option>
        <option value="3" {% if status_filter == '3' %}selected{% endif %}>📦 Giao hàng thành công</option>
      </select>
    </div>
    <div class="col-md-5 d-flex">
      <button type="submit" class="btn btn-primary me-2">Tìm kiếm</button>
      <a href="{% url 'custom_admin:order_list' %}" class="btn btn-secondary">Đặt lại</a>
    </div>
  </div>
</form>

<div style="max-height: 500px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 5px;">
  <table class="table table-bordered table-hover mb-0">
    <thead class="table-light">
      <tr>
        <th>STT</th>
        <th>Khách hàng</th>
        <th>Ngày tạo</th>
        <th>Tổng tiền</th>
        <th>Số điện thoại</th>
        <th>Địa chỉ</th>
        <th>Trạng thái</th>
        <th>Hành động</th>
      </tr>
    </thead>
    <tbody>
      {% for order in orders %}
      <tr>
        <td>{{ forloop.counter }}</td>
        <td>{{ order.user.username }}</td>
        <td>{{ order.create_date|date:"d \T\há\n\g m, Y" }}</td>
        <td>{{ order.total_amount|intcomma }} VND</td>
        <td>{{ order.phone }}</td>
        <td>{{ order.address }}</td>
        <td>
          <select class="form-select status-select" data-order-id="{{ order.id }}">
            <option value="{{ order.status }}" selected>
              {% if order.status == 0 %}🕒 Đang chờ xác nhận
              {% elif order.status == 1 %}✅ Đã xác nhận
              {% elif order.status == 2 %}🚚 Đang giao hàng
              {% elif order.status == 3 %}📦 Giao hàng thành công
              {% else %}❓ Không xác định
              {% endif %}
            </option>
            {% if order.status < 3 %} <option value="{{ order.status|add:1 }}">
              {% if order.status == 0 %}✅ Đã xác nhận
              {% elif order.status == 1 %}🚚 Đang giao hàng
              {% elif order.status == 2 %}📦 Giao hàng thành công
              {% endif %}
              </option>
              {% endif %}
          </select>
        </td>
        <td>
          <a href="{% url 'custom_admin:order_detail' order.id %}" class="btn btn-sm btn-info">Xem</a>
          <a href="{% url 'custom_admin:order_edit' order.id %}" class="btn btn-sm btn-warning">Sửa</a>
          <form action="{% url 'custom_admin:order_delete' order.id %}" method="post" style="display:inline;">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-danger"
              onclick="return confirm('Bạn có chắc muốn xóa đơn hàng này?')">Xóa</button>
          </form>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="8">Không có đơn hàng nào.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  $(document).ready(function () {
    $('.status-select').change(function () {
      var orderId = $(this).data('order-id');
      var newStatus = $(this).val();

      $.ajax({
        url: '{% url "custom_admin:order_update_status" %}',
        type: 'POST',
        data: {
          order_id: orderId,
          status: newStatus,
          csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        success: function (response) {
          if (response.success) {
            alert('Cập nhật trạng thái thành công!');
          } else {
            alert('Có lỗi xảy ra: ' + response.error);
            location.reload();
          }
        },
        error: function () {
          alert('Lỗi kết nối, vui lòng thử lại.');
          location.reload();
        }
      });
    });
  });
</script>
{% endblock %}